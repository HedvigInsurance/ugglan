# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
    lane :upload_dsyms_to_sentry do
        download_dsyms
        sentry_upload_dsym
        clean_build_artifacts
    end
    
    lane :setup do
        carthage(
            command: "bootstrap",
            cache_builds: true,
            platform: "ios"
        )
        
        sh("cd ..; tuist up")
        sh("cd ..; tuist generate")
    end
    
    lane :production_upload do |options|
        setup
        
        app_identifier = "com.hedvig.app"
        
        match(
            type: "appstore",
            app_identifier: app_identifier,
            readonly: is_ci,
            git_url: is_ci ? 'https://#{env["MATCH_GITHUB_TOKEN"]}@github.com:HedvigInsurance/ugglan-certificates.git' : nil
        )
        
        increment_build_number(
            build_number: app_store_build_number(app_identifier: app_identifier) + 1,
            xcodeproj: "Projects/App/Ugglan.xcodeproj"
        )
        
        increment_version_number(
            version_number: options[:version_number],
            xcodeproj: "Projects/App/Ugglan.xcodeproj"
        )
        
        build_app(
            workspace: "Ugglan.xcworkspace",
            configuration: "Release",
            scheme: "Hedvig",
            derived_data_path: "gym-derived-data",
            output_directory: "fastlane/build_output",
            export_options: {
                method: "appstore",
                iCloudContainerEnvironment: "Production"
            }
        )
        
        upload_to_app_store(
            force: true,
            submit_for_review: false,
            skip_screenshots: true,
            skip_metadata: true
        )
    end
    
    lane :workspace_apps do
        setup
        
        apps = {
            "com.hedvig.test.app" => "Ugglan",
            "com.hedvig.app" => "Hedvig",
            "com.hedvig.HomeExample" => "HomeExample"
        }
        
        apps.each do |app_identifier, scheme|
            match(
                type: "adhoc",
                app_identifier: app_identifier,
                readonly: is_ci,
                git_url: is_ci ? 'https://#{env["MATCH_GITHUB_TOKEN"]}@github.com:HedvigInsurance/ugglan-certificates.git' : nil
            )
            build_app(
                workspace: "Ugglan.xcworkspace",
                configuration: "Release",
                scheme: scheme,
                derived_data_path: "gym-derived-data",
                output_directory: "fastlane/build_output",
                export_options: {
                    method: "ad-hoc",
                    iCloudContainerEnvironment: "Development"
                }
            )
        end
    end
    
    lane :workspace_tests do
        setup
        
        schemes = [
            "Ugglan",
            "hCore",
            "hCoreUI",
            "Embark",
            "Forever",
            "Contracts",
            "Home"
        ]
        
        schemes.each { |scheme|
            scan(
                workspace: "Ugglan.xcworkspace",
                devices: ["iPhone 11 Pro"],
                scheme: scheme,
                derived_data_path: "scan_derived_data"
            )
        }
        
        xchtmlreport(
          result_bundle_paths: schemes.map { |scheme| "fastlane/test_output/#{scheme}.xcresult" }
        )
    end
end
