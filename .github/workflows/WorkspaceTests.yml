name: WorkspaceTests

defaults:
  run:
    shell: bash -ieo pipefail {0}

on:
  push:
    branches: [ main ]
  pull_request:
    branches: ['*']

jobs:
  test_ugglan:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Bundle install
      run: arch -arm64 sudo --preserve-env bundle install
    - name: Fastlane Action
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: '180'
        FASTLANE_XCODE_LIST_TIMEOUT: '180'
      run: arch -arm64 bundle exec fastlane ios test scheme:Ugglan
    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: ugglan_output
        path: fastlane/test_output
    - name: Upload test results html
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: ugglan.html
        path: fastlane/test_output/index.html
  test_hCore:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Bundle install
      run: arch -arm64 sudo --preserve-env bundle install
    - name: Fastlane Action
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: '180'
        FASTLANE_XCODE_LIST_TIMEOUT: '180'
      run: arch -arm64 bundle exec fastlane ios test scheme:hCore
    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: hCoreUI_output
        path: fastlane/test_output
    - name: Upload test results html
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: hCore.html
        path: fastlane/test_output/index.html
    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v2
      with:
        report_paths: 'fastlane/test_output/*.junit'
  test_hCoreUI:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Bundle install
      run: arch -arm64 sudo --preserve-env bundle install
    - name: Fastlane Action
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: '180'
        FASTLANE_XCODE_LIST_TIMEOUT: '180'
      run: arch -arm64 bundle exec fastlane ios test scheme:hCoreUI
    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: hCoreUI_output
        path: fastlane/test_output
    - name: Upload test results html
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: hCoreUI.html
        path: fastlane/test_output/index.html
  test_forever:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Bundle install
      run: arch -arm64 sudo --preserve-env bundle install
    - name: Fastlane Action
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: '180'
        FASTLANE_XCODE_LIST_TIMEOUT: '180'
      run: arch -arm64 bundle exec fastlane ios test scheme:Forever
    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: forever_output
        path: fastlane/test_output
    - name: Upload test results html
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: forever.html
        path: fastlane/test_output/index.html
  test_contracts:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Bundle install
      run: arch -arm64 sudo --preserve-env bundle install
    - name: Fastlane Action
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: '180'
        FASTLANE_XCODE_LIST_TIMEOUT: '180'
      run: arch -arm64 bundle exec fastlane ios test scheme:Contracts
    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: contracts_output
        path: fastlane/test_output
    - name: Upload test results html
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: contracts.html
        path: fastlane/test_output/index.html
  test_home:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
    - name: Bundle install
      run: arch -arm64 sudo --preserve-env bundle install
    - name: Fastlane Action
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: '180'
        FASTLANE_XCODE_LIST_TIMEOUT: '180'
      run: arch -arm64 bundle exec fastlane ios test scheme:Home
    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: home_output
        path: fastlane/test_output
    - name: Upload test results html
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: home.html
        path: fastlane/test_output/index.html
