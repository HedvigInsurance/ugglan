name: Weekly Accessibility Audit

on:
  schedule:
    # Runs every Friday at 11:00 AM UTC (5:00 AM CST / 6:00 AM CDT)
    - cron: '0 11 * * 5'
  workflow_dispatch: # Allows manual triggering

jobs:
  accessibility-audit:
    runs-on: macos-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find all Swift files
        id: find-files
        run: |
          # Find all Swift files except tests
          FILES=$(find Projects -name "*.swift" -type f | grep -v Test | tr '\n' ' ')
          echo "swift_files=$FILES" >> $GITHUB_OUTPUT
          echo "Found $(echo $FILES | wc -w | tr -d ' ') Swift files to check"

      - name: Run Accessibility Check
        id: check
        run: |
          chmod +x scripts/check-accessibility.sh
          scripts/check-accessibility.sh "${{ steps.find-files.outputs.swift_files }}" || true
          # Ensure report file exists even if script fails early
          if [ ! -f accessibility-report.md ]; then
            echo "## ðŸ” Accessibility Check Report" > accessibility-report.md
            echo "" >> accessibility-report.md
            echo "âš ï¸ Script failed to generate report" >> accessibility-report.md
          fi
        continue-on-error: true

      - name: Auto-fix Issues
        id: autofix
        if: steps.check.outcome == 'failure'
        run: |
          chmod +x scripts/auto-fix-accessibility.sh
          scripts/auto-fix-accessibility.sh "${{ steps.find-files.outputs.swift_files }}" || true

          # Check if any files were changed
          if [ -n "$(git status --porcelain)" ]; then
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
            echo "Files were modified by auto-fix"
          else
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
            echo "No files were modified"
          fi

      - name: Re-run Accessibility Check
        id: recheck
        if: steps.autofix.outputs.fixes_applied == 'true'
        run: |
          scripts/check-accessibility.sh "${{ steps.find-files.outputs.swift_files }}" || true
          # Ensure report file exists even if script fails early
          if [ ! -f accessibility-report.md ]; then
            echo "## ðŸ” Accessibility Check Report" > accessibility-report.md
            echo "" >> accessibility-report.md
            echo "âš ï¸ Script failed to generate report" >> accessibility-report.md
          fi
        continue-on-error: true

      - name: Create Pull Request with Fixes
        id: create-pr
        if: steps.autofix.outputs.fixes_applied == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix: Auto-fix accessibility issues

            Applied automated accessibility fixes:
            - Added .accessibilityAddTraits(.isButton) to .onTapGesture
            - Added .accessibilityHidden(true) to decorative images
            - Added TODO comments for images needing manual review

            Co-Authored-By: GitHub Actions <actions@github.com>
          branch: automated/accessibility-fixes-${{ github.run_id }}
          delete-branch: true
          title: 'ðŸ¤– Auto-fix Accessibility Issues - ${{ github.run_id }}'
          body: |
            ## ðŸ¤– Automated Accessibility Fixes

            This PR was automatically generated by the Weekly Accessibility Audit workflow.

            **Workflow Run:** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Scan Date:** ${{ github.event.repository.updated_at }}

            ### ðŸ”§ Fixes Applied

            The following automated fixes were applied:

            âœ… **Added `.accessibilityAddTraits(.isButton)` to `.onTapGesture`**
            - Makes tappable views behave like buttons for VoiceOver users

            âœ… **Added `.accessibilityHidden(true)` to decorative icons**
            - Hides purely visual elements from screen readers
            - Only applied to common decorative patterns (chevrons, arrows, etc.)

            âš ï¸ **Added TODO comments for images needing review**
            - Images that need manual `.accessibilityLabel()` assignment
            - Review these and add appropriate L10n keys

            ### ðŸ“Š Remaining Issues

            ${{ steps.recheck.outcome == 'failure' && 'âš ï¸ Some issues still require manual fixes. Check the workflow artifacts for details.' || 'âœ… All detectable accessibility issues have been resolved!' }}

            ### âœ… Review Checklist

            Before merging, please verify:
            - [ ] Auto-generated `.accessibilityHidden(true)` applied only to decorative elements
            - [ ] Review TODO comments and add proper `.accessibilityLabel()` with L10n keys
            - [ ] Test with VoiceOver to ensure fixes work correctly
            - [ ] Check that no unintended changes were made

            ### ðŸ”— Resources
            - [Accessibility Documentation](docs/accessibility-workflow.md)
            - [Apple Accessibility Guidelines](https://developer.apple.com/design/human-interface-guidelines/accessibility)

            ---
            *ðŸ¤– This PR was created automatically. Review carefully before merging.*
          labels: |
            accessibility
            automated
          draft: false

      - name: Read Report
        id: report
        if: always()
        run: |
          if [ -f accessibility-report.md ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue if Manual Fixes Needed
        if: steps.recheck.outcome == 'failure' && steps.autofix.outputs.fixes_applied == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Check if report file exists
            if (!fs.existsSync('accessibility-report.md')) {
              console.log('No accessibility report found, skipping issue creation');
              return;
            }

            const report = fs.readFileSync('accessibility-report.md', 'utf8');

            // Check if there's already an open accessibility issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'accessibility',
              per_page: 100
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Weekly Accessibility Audit')
            );

            const issueBody = `## ðŸ” Weekly Accessibility Audit - Manual Fixes Required

            This is an automated weekly scan of the codebase for accessibility compliance issues.

            **Scan Date:** ${new Date().toISOString().split('T')[0]}
            **Workflow Run:** [View Details](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### ðŸ¤– Auto-Fix PR Created

            A pull request has been automatically created with fixes for common accessibility issues.
            **ðŸ‘‰ Review and merge the auto-fix PR first**, then address the remaining issues below.

            ---

            ## âš ï¸ Remaining Issues Requiring Manual Review

            ${report}

            ---

            ### ðŸ“ How to Fix the Remaining Issues

            These issues require manual review because they need:
            - Proper L10n keys for accessibility labels
            - Human judgment on whether images are decorative or informative
            - Context-specific accessibility hints

            **Steps:**
            1. Review the auto-fix PR and merge it
            2. Review the issues listed above
            3. Add appropriate \`.accessibilityLabel()\` using L10n keys
            4. Test with VoiceOver to verify fixes
            5. Run \`./scripts/check-accessibility.sh\` locally before committing

            ### ðŸ”— Resources
            - [Accessibility Workflow Documentation](docs/accessibility-workflow.md)
            - [Apple Accessibility Guidelines](https://developer.apple.com/design/human-interface-guidelines/accessibility)
            `;

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ Updated Scan Results\n\n${issueBody}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ” Weekly Accessibility Audit - Issues Found',
                body: issueBody,
                labels: ['accessibility', 'automated']
              });
              console.log('Created new accessibility issue');
            }

      - name: Close Issue if No Problems
        if: steps.check.outcome == 'success' || (steps.autofix.outputs.fixes_applied == 'true' && steps.recheck.outcome == 'success')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Find and close any open accessibility audit issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'accessibility',
              per_page: 100
            });

            const accessibilityIssues = issues.data.filter(issue =>
              issue.title.includes('Weekly Accessibility Audit')
            );

            for (const issue of accessibilityIssues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âœ… **All accessibility issues have been resolved!**\n\nThe weekly audit on ${new Date().toISOString().split('T')[0]} found no accessibility issues.\n\nClosing this issue automatically.`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              console.log(`Closed issue #${issue.number}`);
            }

            if (accessibilityIssues.length === 0) {
              console.log('âœ… No accessibility issues found and no open issues to close');
            }

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-accessibility-report-${{ github.run_id }}
          path: accessibility-report.md
          if-no-files-found: ignore
          retention-days: 90
